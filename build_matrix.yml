semaphore: # Default `.semaphore/semaphore.yml` contents
  version: v1.0
  name: AppSignal Ruby Build and Tests

  agent:
    machine:
      type: e1-standard-2
      os_image: ubuntu1804

  # Cancel all running and queued workflows before this one
  auto_cancel:
    running:
      # Ignore master AND develop branch as we want it to build all workflows
      when: "branch != 'master' AND branch != 'develop'"

  global_job_config:
    env_vars:
      - name: "BUNDLE_PATH"
        value: "../.bundle/"
    prologue:
      commands:
        - checkout

  blocks:
    - name: Linters
      dependencies: []
      task:
        prologue:
          commands:
            - sem-version ruby 2.6.5
            - ./support/bundler_wrapper install --jobs=3 --retry=3
        jobs:
        - name: Validate CI setup
          commands:
            - ./support/bundler_wrapper exec rake build_matrix:semaphore:validate
        - name: RuboCop
          commands:
            - ./support/bundler_wrapper exec rubocop

matrix:
  defaults:
    rubygems: "latest"
    bundler: "latest"

  gemsets: # By default all gems are tested
    none:
      - "no_dependencies"
    minimal:
      - "no_dependencies"
      - "rails-5.2"

  ruby:
    - ruby: "1.9.3"
      rubygems: "2.7.8"
      gems: "none"
    - ruby: "2.0.0"
      rubygems: "2.7.8"
    - ruby: "2.1.8"
      rubygems: "2.7.8"
      gems: "none"
    - ruby: "2.2.4"
      rubygems: "2.7.8"
      gems: "none"
    - ruby: "2.3.8"
      gems: "none"
    - ruby: "2.4.5"
      gems: "none"
    - ruby: "2.5.3"
      gems: "minimal"
    - ruby: "2.6.5"
    - ruby: "2.7.0"
    - ruby: "jruby-9.1.17.0"
      gems: "minimal"
  gems:
    - gem: "no_dependencies"
    - gem: "capistrano2"
    - gem: "capistrano3"
    - gem: "grape"
    - gem: "padrino"
      bundler: "1.17.3"
    - gem: "que"
    - gem: "que_beta"
      exclude:
        ruby:
          - "2.0.0"
    - gem: "rails-3.2"
      bundler: "1.17.3"
      exclude:
        ruby:
          - "2.6.5"
          - "2.7.0"
    - gem: "rails-4.2"
      bundler: "1.17.3"
      exclude:
        ruby:
          - "2.6.5"
          - "2.7.0"
    - gem: "rails-5.0"
      exclude:
        ruby:
          - "2.0.0"
    - gem: "rails-5.1"
      exclude:
        ruby:
          - "2.0.0"
    - gem: "rails-5.2"
      exclude:
        ruby:
          - "2.0.0"
    - gem: "rails-6.0"
      exclude:
        ruby:
          - "2.0.0"
          - "2.1.8"
          - "2.2.4"
          - "2.3.8"
          - "2.4.5"
    - gem: "resque"
      bundler: "1.17.3"
    - gem: "sequel"
    - gem: "sequel-435"
    - gem: "sinatra"
    - gem: "webmachine"
